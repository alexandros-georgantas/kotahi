##############################################################
# IMAGE FOR BUILDING

FROM node:18-bookworm-slim

ARG server_url
ARG flax_site_url

ENV NODE_ENV='production'
ENV SERVER_URL=$server_url
ENV CLIENT_STATIC_FOLDER_PATH=../public
ENV FLAX_SITE_URL=$flax_site_url

WORKDIR /home/node/app

COPY package.json .
COPY yarn.lock .

RUN yarn install --frozen-lockfile

COPY . .
RUN touch ./config/translation/translationOverrides.js

RUN yarn coko-client-build

RUN echo $NODE_ENV
RUN echo $SERVER_URL

##############################################################
# IMAGE FOR RUNNING

FROM node:18-bookworm-slim

WORKDIR /home/node/app
USER node

RUN yarn global add serve

COPY --from=0 /home/node/app/_build ./_build
COPY --from=0 /home/node/app/node_modules/@coko/client/scripts/env.sh ./env.sh

ENTRYPOINT ["sh", "./env.sh"]
CMD ["npx", "serve", "-p", "4000", "--single", "./_build"]
